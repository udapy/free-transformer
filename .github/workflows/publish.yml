name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Publish to Test PyPI instead of PyPI'
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.test_pypi == 'true' && 'test-pypi' || 'pypi' }}
      url: ${{ github.event.inputs.test_pypi == 'true' && 'https://test.pypi.org/p/free-transformer' || 'https://pypi.org/p/free-transformer' }}
    
    permissions:
      id-token: write  # For trusted publishing
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: |
        uv venv --python 3.12
        source .venv/bin/activate
        uv pip install -e ".[dev]"
    
    - name: Run tests
      run: |
        source .venv/bin/activate
        make test
    
    - name: Run quality checks
      run: |
        source .venv/bin/activate
        make quality
    
    - name: Build package
      run: |
        source .venv/bin/activate
        make build
    
    - name: Check package
      run: |
        source .venv/bin/activate
        make check-package
    
    - name: Publish to Test PyPI
      if: github.event.inputs.test_pypi == 'true'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        verbose: true
    
    - name: Publish to PyPI
      if: github.event.inputs.test_pypi != 'true'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        verbose: true
    
    - name: Create GitHub Release Notes
      if: github.event_name == 'release'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
          
          // Extract the latest version's changes
          const lines = changelog.split('\n');
          let inCurrentVersion = false;
          let releaseNotes = [];
          
          for (const line of lines) {
            if (line.startsWith('## [') && !line.includes('Unreleased')) {
              if (inCurrentVersion) break;
              inCurrentVersion = true;
              continue;
            }
            if (inCurrentVersion && line.startsWith('## [')) {
              break;
            }
            if (inCurrentVersion) {
              releaseNotes.push(line);
            }
          }
          
          const notes = releaseNotes.join('\n').trim();
          
          await github.rest.repos.updateRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: context.payload.release.id,
            body: notes
          });